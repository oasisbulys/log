generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int            @id @default(autoincrement())
  username        String         @unique
  passphrase_hash String
  avatar_url      String?
  xp              Int            @default(0)
  rank            String         @default("NOVICE")
  streak          Int            @default(0)
  created_at      DateTime       @default(now())
  sessions        StudySession[]
  activity        ActivityLog[]
  comments      Comment[]
  questProgress QuestProgress[]
}

model StudySession {
  id               Int      @id @default(autoincrement())
  user             User     @relation(fields: [userId], references: [id])
  userId           Int
  subject          String
  intent           String   // REVISION, PROBLEM_SOLVING, etc.
  duration_seconds Int
  time_window      String?  // MORNING, AFTERNOON, NIGHT
  created_at       DateTime @default(now())
}

model ActivityLog {
  id         Int      @id @default(autoincrement())
  user       User     @relation(fields: [userId], references: [id])
  userId     Int
  type       String   // STUDY, QUEST, PROOF
  text       String
  image_url  String?
  created_at DateTime  @default(now())
  comments   Comment[]
}

model Comment {
  id            Int         @id @default(autoincrement())
  activityLog   ActivityLog @relation(fields: [activityLogId], references: [id])
  activityLogId Int
  user          User        @relation(fields: [userId], references: [id])
  userId        Int
  text          String
  created_at    DateTime    @default(now())
}

model Quest {
  id            Int      @id @default(autoincrement())
  title         String
  description   String
  target_hours  Int
  xp_reward     Int
  created_at    DateTime @default(now())
  progress      QuestProgress[]
}

model QuestProgress {
  id             Int      @id @default(autoincrement())
  user           User     @relation(fields: [userId], references: [id])
  userId         Int
  quest          Quest    @relation(fields: [questId], references: [id])
  questId        Int
  progress_hours Float    @default(0.0)
  completed_at   DateTime?
  @@unique([userId, questId])
}
